var emulator={runGame:function(){document.getElementById("middle-content").style.display="none",cpu.reset(),cpu.timer=window.setInterval(emulator.runFrame,17)},runFrame:function(){for(;0===ppu.scanline;)cpu.ex(memory.readByte(cpu.pc));for(;0!==ppu.scanline;)cpu.ex(memory.readByte(cpu.pc))},loadROM:function(){var e=document.getElementById("romFileInput").files[0];if(void 0===e)alert("Please Select a File");else{var p=new FileReader;p.onload=function(e){var c=new Uint8Array(p.result);if(!1&c[7]&&c[9]<<8<c.size)emulator.iNES2Handler(c);else{if(0!=(12&c[7]|c[12]|c[13]|c[14]|c[15])){alert("File Not Supported"),header=prgRom.slice(0,16),console.log(header);for(var a=1;a<16;a++)console.log(c[a].toString(16));return}emulator.iNESHandler(c)}var r=document.getElementById("middle-content"),u=document.getElementById("footer");u.style.position="fixed",u.style.bottom=0;var t="-"+r.clientHeight.toString()+"px";r.style.top=t,r.addEventListener("transitionend",emulator.runGame)},p.readAsArrayBuffer(e)}},iNESHandler:function(e){console.log("iNES1.0");for(var p=[0],c=0,a=0;a<16;a++)p[a]=e[c],c++;ppu.nametableMirroring=2+(1&p[6]),console.log("mirroring mode:",ppu.nametableMirroring),4&p[6]&&(c+=512,console.log("trainer fie exists but was ignored")),8&p[6]&&(ppu.nametableMirroring=4,console.log("mirroring mode not yet supported"));for(var r=16384*p[4],a=0;a<r;a++)prgRom[a]=e[c],c++;for(var u=8192*p[5],a=0;a<u;a++)chrRom[a]=e[c],c++;c!=e.length?(console.log("romFile!=x"),console.log(romfile.length,"-",c,"=",e.length-c)):console.log("loading ROM miraculously Succeeded");var t=p[6]>>4&15;t|=240&p[7],console.log("Mapper:",t),mapperInit(t)},iNES2Handler:function(){console.log("iNES2.0")},init:function(){ppu.init(),cpu.wRamInit()},showState:function(){cpu.showState(),ppu.showState()}},cpu={a:0,x:0,y:0,pc:0,sp:253,sr:32,clk:0,cycle:0,pcPrev:0,BRK:function(){memory.writeWord((256|cpu.sp)-1,cpu.pc+2),cpu.sp=cpu.sp-2&255,memory.writeByte(256|cpu.sp,48|cpu.sr),cpu.sp=cpu.sp-1&255,cpu.setInterruptFlag(),cpu.pc=memory.readWord(memory.irqVector),cpu.clk=7},ORA_IX:function(){var e=memory.readWord(memory.readByte(cpu.pc+1)+cpu.x&255);cpu.a|=memory.readByte(e),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=6},HLT:function(){},SLO_IX:function(){var e=memory.readWord(memory.readByte(cpu.pc+1)+cpu.x&255),p=memory.readByte(e);128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,memory.writeByte(e,p),cpu.a|=p,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=8},NOP:function(){cpu.pc+=1,cpu.clk=2},ORA_ZP:function(){cpu.a|=memory.readByte(memory.readByte(cpu.pc+1)),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=3},ASL_ZP:function(){var e=memory.readByte(cpu.pc+1),p=memory.readByte(e);128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,memory.writeByte(e,p),p>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=5},SLO_ZP:function(){var e=memory.readByte(cpu.pc+1),p=memory.readByte(e);128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,memory.writeByte(e,p),cpu.a|=p,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=5},PHP:function(){memory.writeByte(256|cpu.sp,48|cpu.sr),cpu.sp=cpu.sp-1&255,cpu.pc+=1,cpu.clk=3},ORA_IMM:function(){cpu.a|=memory.readByte(cpu.pc+1),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=2},ASL_A:function(){128&cpu.a?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a=cpu.a<<1&255,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=1,cpu.clk=2},ANC_IMM:function(){cpu.a&=memory.readByte(cpu.pc+1),128&cpu.a?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=2},TOP:function(){cpu.pc+=3,cpu.clk=2},ORA_AB:function(){cpu.a|=memory.readByte(memory.readWord(cpu.pc+1)),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},ASL_AB:function(){var e=memory.readWord(cpu.pc+1),p=memory.readByte(e);128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,memory.writeByte(e,p),p>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=6},SLO_AB:function(){var e=memory.readWord(cpu.pc+1),p=memory.readByte(e);128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,memory.writeByte(e,p),cpu.a|=p,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=6},BPL:function(){cpu.clk=2,cpu.negativeFlag()||(cpu.pc+=cpu.signDecode(memory.readByte(cpu.pc+1)),cpu.clk++),cpu.pc+=2},ORA_IY:function(){var e=memory.readWord(memory.readByte(cpu.pc+1))+cpu.y;cpu.a|=memory.readByte(e),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=5},SLO_IY:function(){var e=memory.readWord(memory.readByte(cpu.pc+1))+cpu.y,p=memory.readByte(e);128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,memory.writeByte(e,p),cpu.a|=p,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=8},ORA_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255;cpu.a|=memory.readByte(e),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=4},ASL_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255,p=memory.readByte(e);128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,memory.writeByte(e,p),p>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=6},SLO_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255,p=memory.readByte(e);128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,memory.writeByte(e,p),cpu.a|=p,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=6},CLC:function(){cpu.resetCarryFlag(),cpu.pc+=1,cpu.clk=2},ORA_ABY:function(){var e=memory.readWord(cpu.pc+1)+cpu.y;cpu.a|=memory.readByte(e),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},SLO_ABY:function(){var e=memory.readWord(cpu.pc+1)+cpu.y,p=memory.readByte(e);128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,memory.writeByte(e,p),cpu.a|=p,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=7},ORA_ABX:function(){var e=memory.readWord(cpu.pc+1)+cpu.x;cpu.a|=memory.readByte(e),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},ASL_ABX:function(){var e=memory.readWord(cpu.pc+1)+cpu.x,p=memory.readByte(e);128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,memory.writeByte(e,p),p>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=7},SLO_ABX:function(){var e=memory.readWord(cpu.pc+1)+cpu.x,p=memory.readByte(e);128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,memory.writeByte(e,p),cpu.a|=p,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=7},JSR:function(){debug.callStack.push(cpu.pc.toString(16)),memory.writeWord((256|cpu.sp)-1,cpu.pc+2),cpu.sp-=2,cpu.pc=memory.readWord(cpu.pc+1),cpu.clk=6},AND_IX:function(){var e=memory.readWord(memory.readByte(cpu.pc+1)+cpu.x&255);cpu.a&=memory.readByte(e),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=6},RLA_IX:function(){var e=memory.readWord(memory.readByte(cpu.pc+1)+cpu.x&255),p=memory.readByte(e),c=cpu.carryFlag()?1:0;128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,p|=c,memory.writeByte(e,p),cpu.a&=p,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=8},BIT_ZP:function(){var e=memory.readByte(memory.readByte(cpu.pc+1));128&e?cpu.setNegativeFlag():cpu.resetNegativeFlag(),64&e?cpu.setOverflowFlag():cpu.resetOverflowFlag(),e&cpu.a?cpu.resetZeroFlag():cpu.setZeroFlag(),cpu.pc+=2,cpu.clk=3},AND_ZP:function(){cpu.a&=memory.readByte(memory.readByte(cpu.pc+1)),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=3},ROL_ZP:function(){var e=memory.readByte(cpu.pc+1),p=memory.readByte(e),c=cpu.carryFlag()?1:0;128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,p|=c,memory.writeByte(e,p),p>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=5},RLA_ZP:function(){var e=memory.readByte(cpu.pc+1),p=memory.readByte(e),c=cpu.carryFlag()?1:0;128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,p|=c,memory.writeByte(e,p),cpu.a&=p,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=5},PLP:function(){cpu.sp=cpu.sp+1&255,cpu.sr=memory.readByte(256|cpu.sp),cpu.sr|=32,cpu.sr&=239,cpu.pc+=1,cpu.clk=4},AND_IMM:function(){cpu.a&=memory.readByte(cpu.pc+1),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=2},ROL_A:function(){var e=cpu.carryFlag()?1:0;128&cpu.a?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a=cpu.a<<1&255,cpu.a|=e,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=1,cpu.clk=2},BIT_AB:function(){var e=memory.readByte(memory.readWord(cpu.pc+1));128&e?cpu.setNegativeFlag():cpu.resetNegativeFlag(),64&e?cpu.setOverflowFlag():cpu.resetOverflowFlag(),e&cpu.a?cpu.resetZeroFlag():cpu.setZeroFlag(),cpu.pc+=3,cpu.clk=4},AND_AB:function(){cpu.a&=memory.readByte(memory.readWord(cpu.pc+1)),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},ROL_AB:function(){var e=memory.readWord(cpu.pc+1),p=memory.readByte(e),c=cpu.carryFlag()?1:0;128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,p|=c,memory.writeByte(e,p),p>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=6},RLA_AB:function(){var e=memory.readWord(cpu.pc+1),p=memory.readByte(e),c=cpu.carryFlag()?1:0;128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,p|=c,memory.writeByte(e,p),cpu.a&=p,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=6},BMI:function(){cpu.clk=2,cpu.negativeFlag()&&(cpu.pc+=cpu.signDecode(memory.readByte(cpu.pc+1)),cpu.clk++),cpu.pc+=2},AND_IY:function(){var e=memory.readWord(memory.readByte(cpu.pc+1))+cpu.y;cpu.a&=memory.readByte(e),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=5},RLA_IY:function(){var e=memory.readWord(memory.readByte(cpu.pc+1))+cpu.y,p=memory.readByte(e),c=cpu.carryFlag()?1:0;128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,p|=c,memory.writeByte(e,p),cpu.a&=p,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=8},AND_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255;cpu.a&=memory.readByte(e),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=4},ROL_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255,p=memory.readByte(e),c=cpu.carryFlag()?1:0;128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,p|=c,memory.writeByte(e,p),p>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=6},RLA_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255,p=memory.readByte(e),c=cpu.carryFlag()?1:0;128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,p|=c,memory.writeByte(e,p),cpu.a&=p,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=6},SEC:function(){cpu.setCarryFlag(),cpu.pc+=1,cpu.clk=2},AND_ABY:function(){var e=memory.readWord(cpu.pc+1)+cpu.y;cpu.a&=memory.readByte(e),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},RLA_ABY:function(){var e=memory.readWord(cpu.pc+1)+cpu.y,p=memory.readByte(e),c=cpu.carryFlag()?1:0;128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,p|=c,memory.writeByte(e,p),cpu.a&=p,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=7},AND_ABX:function(){var e=memory.readWord(cpu.pc+1)+cpu.x;cpu.a&=memory.readByte(e),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},ROL_ABX:function(){var e=memory.readWord(cpu.pc+1)+cpu.x,p=memory.readByte(e),c=cpu.carryFlag()?1:0;128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,p|=c,memory.writeByte(e,p),p>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=7},RLA_ABX:function(){var e=memory.readWord(cpu.pc+1)+cpu.x,p=memory.readByte(e),c=cpu.carryFlag()?1:0;128&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p=p<<1&255,p|=c,memory.writeByte(e,p),cpu.a&=p,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=7},RTI:function(){debug.callStack.pop(),cpu.sp=cpu.sp+1&255,cpu.sr=memory.readByte(256|cpu.sp),cpu.sp=cpu.sp+2&255,cpu.pc=memory.readWord((256|cpu.sp)-1),cpu.sr|=32,cpu.sr&=239,cpu.clk=6},EOR_IX:function(){var e=memory.readWord(memory.readByte(cpu.pc+1)+cpu.x&255);cpu.a^=memory.readByte(e),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=6},SRE_IX:function(){var e=memory.readWord(memory.readByte(cpu.pc+1)+cpu.x&255),p=memory.readByte(e);1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p>>=1,memory.writeByte(e,p),cpu.a^=p,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=8},EOR_ZP:function(){cpu.a^=memory.readByte(memory.readByte(cpu.pc+1)),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=3},LSR_ZP:function(){var e=memory.readByte(cpu.pc+1),p=memory.readByte(e);1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p>>=1,memory.writeByte(e,p),cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=5},SRE_ZP:function(){var e=memory.readByte(cpu.pc+1),p=memory.readByte(e);1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p>>=1,memory.writeByte(e,p),cpu.a^=p,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=5},PHA:function(){memory.writeByte(511&(256|cpu.sp),cpu.a),cpu.sp=cpu.sp-1&255,cpu.pc+=1,cpu.clk=3},EOR_IMM:function(){cpu.a^=memory.readByte(cpu.pc+1),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=2},LSR_A:function(){1&cpu.a?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a=cpu.a>>1&255,cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=1,cpu.clk=2},ALR_IMM:function(){var e=memory.readByte(cpu.pc+1);cpu.a&=e,1&cpu.a?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a=cpu.a>>1&255,cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=2},JMP_A:function(){var e=memory.readWord(cpu.pc+1);cpu.pc=e,cpu.clk=3},EOR_AB:function(){cpu.a^=memory.readByte(memory.readWord(cpu.pc+1)),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},LSR_AB:function(){var e=memory.readWord(cpu.pc+1),p=memory.readByte(e);1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p>>=1,memory.writeByte(e,p),cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=6},SRE_AB:function(){var e=memory.readWord(cpu.pc+1),p=memory.readByte(e);1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p>>=1,memory.writeByte(e,p),cpu.a^=p,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=6},BVC:function(){cpu.clk=2,cpu.overflowFlag()||(cpu.pc+=cpu.signDecode(memory.readByte(cpu.pc+1)),cpu.clk+=1),cpu.pc+=2},EOR_IY:function(){var e=memory.readWord(memory.readByte(cpu.pc+1))+cpu.y;cpu.a^=memory.readByte(e),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=5},SRE_IY:function(){var e=memory.readWord(memory.readByte(cpu.pc+1))+cpu.y,p=memory.readByte(e);1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p>>=1,memory.writeByte(e,p),cpu.a^=p,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=8},EOR_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255;cpu.a^=memory.readByte(e),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=4},LSR_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255,p=memory.readByte(e);1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p>>=1,memory.writeByte(e,p),cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=6},SRE_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255,p=memory.readByte(e);1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p>>=1,memory.writeByte(e,p),cpu.a^=p,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=6},CLI:function(){cpu.resetInterruptFlag(),cpu.pc+=1,cpu.clk=2},EOR_ABY:function(){var e=memory.readWord(cpu.pc+1)+cpu.y;cpu.a^=memory.readByte(e),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},SRE_ABY:function(){var e=memory.readWord(cpu.pc+1)+cpu.y,p=memory.readByte(e);1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p>>=1,memory.writeByte(e,p),cpu.a^=p,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=7},EOR_ABX:function(){var e=memory.readWord(cpu.pc+1)+cpu.x;cpu.a^=memory.readByte(e),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},LSR_ABX:function(){var e=memory.readWord(cpu.pc+1)+cpu.x,p=memory.readByte(e);1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p>>=1,memory.writeByte(e,p),cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=7},SRE_ABX:function(){var e=memory.readWord(cpu.pc+1)+cpu.x,p=memory.readByte(e);1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p>>=1,memory.writeByte(e,p),cpu.a^=p,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=7},RTS:function(){debug.callStack.pop(),cpu.sp=cpu.sp+2&255,cpu.pc=memory.readWord((256|cpu.sp)-1)+1,cpu.clk=6},ADC_IX:function(){var e=memory.readWord(memory.readByte(cpu.pc+1)+cpu.x&255),p=memory.readByte(e),c=cpu.carryFlag()?1:0,a=cpu.a+p+c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=6},RRA_IX:function(){var e=memory.readWord(memory.readByte(cpu.pc+1)+cpu.x&255),p=memory.readByte(e);cpu.carryFlag()&&(p|=256),1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p>>=1,memory.writeByte(e,p);var c=cpu.carryFlag()?1:0,a=cpu.a+p+c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=8},ADC_ZP:function(){var e=memory.readByte(cpu.pc+1),p=memory.readByte(e),c=cpu.carryFlag()?1:0,a=cpu.a+p+c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=3},ROR_ZP:function(){var e=memory.readByte(cpu.pc+1),p=memory.readByte(e);cpu.carryFlag()&&(p|=256),1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),(p>>=1)>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),memory.writeByte(e,p),cpu.pc+=2,cpu.clk=5},RRA_ZP:function(){var e=memory.readByte(cpu.pc+1),p=memory.readByte(e);cpu.carryFlag()&&(p|=256),1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p>>=1,memory.writeByte(e,p);var c=cpu.carryFlag()?1:0,a=cpu.a+p+c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=5},PLA:function(){cpu.sp=cpu.sp+1&255,cpu.a=memory.readByte(256|cpu.sp),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=1,cpu.clk=4},ADC_IMM:function(){var e=memory.readByte(cpu.pc+1),p=cpu.carryFlag()?1:0,c=cpu.a+e+p;256&c?(c&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^c)&(e^c)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=c,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=2},ROR_A:function(){cpu.carryFlag()&&(cpu.a|=256),1&cpu.a?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a=cpu.a>>1,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=1,cpu.clk=2},ARR_IMM:function(){cpu.a&=memory.readByte(cpu.pc+1),64&(cpu.a^cpu.a>>1)?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.carryFlag()&&(cpu.a|=256),128&cpu.a?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a=cpu.a>>1,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=2},JMP_I:function(){var e=memory.readWord(cpu.pc+1),p=memory.readWord(e);255==(255&e)&&(p&=255,p|=memory.readByte(e-255)<<8),cpu.pc=p,cpu.clk=5},ADC_AB:function(){var e=memory.readWord(cpu.pc+1),p=memory.readByte(e),c=cpu.carryFlag()?1:0,a=cpu.a+p+c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},ROR_AB:function(){var e=memory.readWord(cpu.pc+1),p=memory.readByte(e);cpu.carryFlag()&&(p|=256),1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),(p>>=1)>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),memory.writeByte(e,p),cpu.pc+=3,cpu.clk=6},RRA_AB:function(){var e=memory.readWord(cpu.pc+1),p=memory.readByte(e);cpu.carryFlag()&&(p|=256),1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p>>=1,memory.writeByte(e,p);var c=cpu.carryFlag()?1:0,a=cpu.a+p+c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=6},BVS:function(){cpu.clk=2,cpu.overflowFlag()&&(cpu.pc+=cpu.signDecode(memory.readByte(cpu.pc+1)),cpu.clk+=1),cpu.pc+=2},ADC_IY:function(){var e=memory.readWord(memory.readByte(cpu.pc+1))+cpu.y,p=memory.readByte(e),c=cpu.carryFlag()?1:0,a=cpu.a+p+c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=5},RRA_IY:function(){var e=memory.readWord(memory.readByte(cpu.pc+1))+cpu.y,p=memory.readByte(e);cpu.carryFlag()&&(p|=256),1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p>>=1,memory.writeByte(e,p);var c=cpu.carryFlag()?1:0,a=cpu.a+p+c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=8},ADC_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255,p=memory.readByte(e),c=cpu.carryFlag()?1:0,a=cpu.a+p+c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=4},ROR_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255,p=memory.readByte(e);cpu.carryFlag()&&(p|=256),1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),(p>>=1)>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),memory.writeByte(e,p),cpu.pc+=2,cpu.clk=6},RRA_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255,p=memory.readByte(e);cpu.carryFlag()&&(p|=256),1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p>>=1,memory.writeByte(e,p);var c=cpu.carryFlag()?1:0,a=cpu.a+p+c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=6},SEI:function(){cpu.setInterruptFlag(),cpu.pc+=1,cpu.clk=2},ADC_ABY:function(){var e=memory.readWord(cpu.pc+1)+cpu.y,p=memory.readByte(e),c=cpu.carryFlag()?1:0,a=cpu.a+p+c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},RRA_ABY:function(){var e=memory.readWord(cpu.pc+1)+cpu.y,p=memory.readByte(e);cpu.carryFlag()&&(p|=256),1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p>>=1,memory.writeByte(e,p);var c=cpu.carryFlag()?1:0,a=cpu.a+p+c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=7},ADC_ABX:function(){var e=memory.readWord(cpu.pc+1)+cpu.x,p=memory.readByte(e),c=cpu.carryFlag()?1:0,a=cpu.a+p+c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},ROR_ABX:function(){var e=memory.readWord(cpu.pc+1)+cpu.x,p=memory.readByte(e);cpu.carryFlag()&&(p|=256),1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),(p>>=1)>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),memory.writeByte(e,p),cpu.pc+=3,cpu.clk=7},RRA_ABX:function(){var e=memory.readWord(cpu.pc+1)+cpu.x,p=memory.readByte(e);cpu.carryFlag()&&(p|=256),1&p?cpu.setCarryFlag():cpu.resetCarryFlag(),p>>=1,memory.writeByte(e,p);var c=cpu.carryFlag()?1:0,a=cpu.a+p+c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=7},STA_IX:function(){var e=memory.readWord(memory.readByte(cpu.pc+1)+cpu.x&255);memory.writeByte(e,cpu.a),cpu.pc+=2,cpu.clk=6},SAX_IX:function(){var e=memory.readWord(memory.readByte(cpu.pc+1)+cpu.x&255),p=cpu.a&cpu.x;memory.writeByte(e,p),cpu.pc+=2,cpu.clk=6},STY_ZP:function(){memory.writeByte(memory.readByte(cpu.pc+1),cpu.y),cpu.pc+=2,cpu.clk=4},STA_ZP:function(){memory.writeByte(memory.readByte(cpu.pc+1),cpu.a),cpu.pc+=2,cpu.clk=4},STX_ZP:function(){memory.writeByte(memory.readByte(cpu.pc+1),cpu.x),cpu.pc+=2,cpu.clk=4},SAX_ZP:function(){var e=memory.readByte(cpu.pc+1),p=cpu.a&cpu.x;memory.writeByte(e,p),cpu.pc+=2,cpu.clk=3},DEY:function(){cpu.y=cpu.y-1&255,cpu.y>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.y?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=1,cpu.clk=2},DOP:function(){cpu.pc+=2,cpu.clk=2},TXA:function(){cpu.a=cpu.x,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=1,cpu.clk=2},XAA_IMM:function(){cpu.a=cpu.x,cpu.a&=memory.readByte(cpu.pc+1),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=1,cpu.clk=2},STY_AB:function(){memory.writeByte(memory.readWord(cpu.pc+1),cpu.y),cpu.pc+=3,cpu.clk=4},STA_AB:function(){memory.writeByte(memory.readWord(cpu.pc+1),cpu.a),cpu.pc+=3,cpu.clk=4},STX_AB:function(){memory.writeByte(memory.readWord(cpu.pc+1),cpu.x),cpu.pc+=3,cpu.clk=4},SAX_AB:function(){var e=memory.readWord(cpu.pc+1),p=cpu.a&cpu.x;memory.writeByte(e,p),cpu.pc+=3,cpu.clk=4},BCC:function(){cpu.clk=2,cpu.carryFlag()||(cpu.pc+=cpu.signDecode(memory.readByte(cpu.pc+1)),cpu.clk+=1),cpu.pc+=2},STA_IY:function(){var e=memory.readWord(memory.readByte(cpu.pc+1))+cpu.y;memory.writeByte(e,cpu.a),cpu.pc+=2,cpu.clk=6},AHX_IY:function(){var e=memory.readWord(memory.readByte(cpu.pc+1))+cpu.y;memory.writeByte(e,cpu.a&cpu.x&e>>8),cpu.pc+=2,cpu.clk=6},STY_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255;memory.writeByte(e,cpu.y),cpu.pc+=2,cpu.clk=4},STA_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255;memory.writeByte(e,cpu.a),cpu.pc+=2,cpu.clk=4},STX_ZPY:function(){var e=memory.readByte(cpu.pc+1)+cpu.y&255;memory.writeByte(e,cpu.x),cpu.pc+=2,cpu.clk=4},SAX_ZPY:function(){var e=memory.readByte(cpu.pc+1)+cpu.y&255,p=cpu.a&cpu.x;memory.writeByte(e,p),cpu.pc+=2,cpu.clk=4},TYA:function(){cpu.a=cpu.y,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=1,cpu.clk=2},STA_ABY:function(){var e=memory.readWord(cpu.pc+1)+cpu.y;memory.writeByte(e,cpu.a),cpu.pc+=3,cpu.clk=5},TXS:function(){cpu.sp=cpu.x,cpu.pc+=1,cpu.clk=2},TAS_ABY:function(){var e=memory.readWord(cpu.pc+1)+cpu.x;cpu.sp=cpu.a&cpu.x,memory.writeByte(e,cpu.sp&e>>8),cpu.pc+=3,cpu.clk=5},SHY_ABX:function(){var e=memory.readByte(cpu.pc+2),p=memory.readWord(cpu.pc+1)+cpu.x,c=e&cpu.y;(255&memory.readWord(cpu.pc+1))==(255&p)&&memory.writeByte(p,c),cpu.pc+=3,cpu.clk=5},STA_ABX:function(){var e=memory.readWord(cpu.pc+1)+cpu.x;memory.writeByte(e,cpu.a),cpu.pc+=3,cpu.clk=5},SHX_ABY:function(){var e=memory.readByte(cpu.pc+2)+1,p=memory.readWord(cpu.pc+1)+cpu.y,c=e&cpu.x;memory.writeByte(p,c),cpu.pc+=3,cpu.clk=5},AHX_ABY:function(){var e=memory.readWord(cpu.pc+1)+cpu.y;memory.writeByte(e,cpu.a&cpu.x&e>>8),cpu.pc+=3,cpu.clk=6},LDY_IMM:function(){cpu.y=memory.readByte(cpu.pc+1),cpu.y>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.y?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=2},LDA_IX:function(){var e=memory.readWord(memory.readByte(cpu.pc+1)+cpu.x&255);cpu.a=memory.readByte(e),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=6},LDX_IMM:function(){cpu.x=memory.readByte(cpu.pc+1),cpu.x>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.x?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=2},LAX_IX:function(){var e=memory.readWord(memory.readByte(cpu.pc+1)+cpu.x&255);cpu.a=memory.readByte(e),cpu.x=memory.readByte(e),cpu.x>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.x?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=6},LDY_ZP:function(){cpu.y=memory.readByte(memory.readByte(cpu.pc+1)),cpu.y>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.y?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=3},LDA_ZP:function(){cpu.a=memory.readByte(memory.readByte(cpu.pc+1)),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=3},LDX_ZP:function(){cpu.x=memory.readByte(memory.readByte(cpu.pc+1)),cpu.x>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.x?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=3},LAX_ZP:function(){var e=memory.readByte(cpu.pc+1);cpu.a=memory.readByte(e),cpu.x=memory.readByte(e),cpu.x>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.x?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=3},TAY:function(){cpu.y=cpu.a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=1,cpu.clk=2},LDA_IMM:function(){cpu.a=memory.readByte(cpu.pc+1),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=2},TAX:function(){cpu.x=cpu.a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=1,cpu.clk=2},LAX_IMM:function(){cpu.a=memory.readByte(cpu.pc+1),cpu.x=memory.readByte(cpu.pc+1),cpu.x>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.x?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=6},LDY_AB:function(){cpu.y=memory.readByte(memory.readWord(cpu.pc+1)),cpu.y>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.y?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},LDA_AB:function(){cpu.a=memory.readByte(memory.readWord(cpu.pc+1)),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},LDX_AB:function(){cpu.x=memory.readByte(memory.readWord(cpu.pc+1)),cpu.x>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.x?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},LAX_AB:function(){var e=memory.readWord(cpu.pc+1);cpu.a=memory.readByte(e),cpu.x=memory.readByte(e),cpu.x>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.x?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},BCS:function(){cpu.clk=2,cpu.carryFlag()&&(cpu.pc+=cpu.signDecode(memory.readByte(cpu.pc+1)),cpu.clk+=1),cpu.pc+=2},LDA_IY:function(){var e=memory.readWord(memory.readByte(cpu.pc+1))+cpu.y;cpu.a=memory.readByte(e),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=5},LAX_IY:function(){var e=memory.readWord(memory.readByte(cpu.pc+1))+cpu.y;cpu.a=memory.readByte(e),cpu.x=memory.readByte(e),cpu.x>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.x?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=5},LDY_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255;cpu.y=memory.readByte(e),cpu.y>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.y?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=4},LDA_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255;cpu.a=memory.readByte(e),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=4},LDX_ZPY:function(){var e=memory.readByte(cpu.pc+1)+cpu.y&255;cpu.x=memory.readByte(e),cpu.x>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.x?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=4},LAX_ZPY:function(){var e=memory.readByte(cpu.pc+1)+cpu.y&255;cpu.a=memory.readByte(e),cpu.x=memory.readByte(e),cpu.x>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.x?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=4},CLV:function(){cpu.resetOverflowFlag(),cpu.pc+=1,cpu.clk=2},LDA_ABY:function(){var e=memory.readWord(cpu.pc+1)+cpu.y;cpu.a=memory.readByte(e),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},TSX:function(){cpu.x=cpu.sp,cpu.x>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.x?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=1,cpu.clk=2},LAS_ABY:function(){var e=memory.readWord(cpu.pc+1)+cpu.y,p=memory.readByte(e);p&=cpu.sp,cpu.a=p,cpu.x=p,cpu.sp=p,cpu.pc+=3,cpu.clk=4},LDY_ABX:function(){var e=memory.readWord(cpu.pc+1)+cpu.x;cpu.y=memory.readByte(e),cpu.y>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.y?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},LDA_ABX:function(){var e=memory.readWord(cpu.pc+1)+cpu.x;cpu.a=memory.readByte(e),cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},LDX_ABY:function(){var e=memory.readWord(cpu.pc+1)+cpu.y;cpu.x=memory.readByte(e),cpu.x>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.x?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},LAX_ABY:function(){var e=memory.readWord(cpu.pc+1)+cpu.y;cpu.a=memory.readByte(e),cpu.x=memory.readByte(e),cpu.x>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.x?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},CPY_IMM:function(){var e=memory.readByte(cpu.pc+1);cpu.y-e&128?cpu.setNegativeFlag():cpu.resetNegativeFlag(),cpu.y>=e?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.y===e?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=2},CMP_IX:function(){var e=memory.readWord(memory.readByte(cpu.pc+1)+cpu.x&255),p=memory.readByte(e);cpu.a-p&128?cpu.setNegativeFlag():cpu.resetNegativeFlag(),cpu.a>=p?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=6},DCP_IX:function(){var e=memory.readWord(memory.readByte(cpu.pc+1)+cpu.x&255),p=memory.readByte(e);p=p-1&255,memory.writeByte(e,p),cpu.a-p&128?cpu.setNegativeFlag():cpu.resetNegativeFlag(),cpu.a>=p?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=8},CPY_ZP:function(){var e=memory.readByte(cpu.pc+1),p=memory.readByte(e);cpu.y-p&128?cpu.setNegativeFlag():cpu.resetNegativeFlag(),cpu.y>=p?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.y===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=3},CMP_ZP:function(){var e=memory.readByte(cpu.pc+1),p=memory.readByte(e);cpu.a-p&128?cpu.setNegativeFlag():cpu.resetNegativeFlag(),cpu.a>=p?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=3},DEC_ZP:function(){var e=memory.readByte(cpu.pc+1),p=memory.readByte(e);p=p-1&255,memory.writeByte(e,p),p>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=5},DCP_ZP:function(){var e=memory.readByte(cpu.pc+1),p=memory.readByte(e);p=p-1&255,memory.writeByte(e,p),cpu.a-p&128?cpu.setNegativeFlag():cpu.resetNegativeFlag(),cpu.a>=p?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=5},INY:function(){cpu.y=cpu.y+1&255,cpu.y>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.y?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=1,cpu.clk=2},CMP_IMM:function(){var e=memory.readByte(cpu.pc+1);cpu.a-e&128?cpu.setNegativeFlag():cpu.resetNegativeFlag(),cpu.a>=e?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a===e?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=2},DEX:function(){cpu.x=cpu.x-1&255,cpu.x>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.x?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=1,cpu.clk=2},AXS_IMM:function(){cpu.x&=cpu.a;var e=1+(255&~memory.readByte(cpu.pc+1)),p=cpu.x+e;256&p?(p&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),cpu.x=p,cpu.x>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.x?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=2},CPY_AB:function(){var e=memory.readWord(cpu.pc+1),p=memory.readByte(e);cpu.y-p&128?cpu.setNegativeFlag():cpu.resetNegativeFlag(),cpu.y>=p?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.y===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},CMP_AB:function(){var e=memory.readWord(cpu.pc+1),p=memory.readByte(e);cpu.a-p&128?cpu.setNegativeFlag():cpu.resetNegativeFlag(),cpu.a>=p?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},DEC_AB:function(){var e=memory.readWord(cpu.pc+1),p=memory.readByte(e);p=p-1&255,memory.writeByte(e,p),p>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=6},DCP_AB:function(){var e=memory.readWord(cpu.pc+1),p=memory.readByte(e);p=p-1&255,memory.writeByte(e,p),cpu.a-p&128?cpu.setNegativeFlag():cpu.resetNegativeFlag(),cpu.a>=p?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=6},BNE:function(){cpu.clk=2,cpu.zeroFlag()||(cpu.pc+=cpu.signDecode(memory.readByte(cpu.pc+1)),cpu.clk+=1),cpu.pc+=2},CMP_IY:function(){var e=memory.readWord(memory.readByte(cpu.pc+1))+cpu.y,p=memory.readByte(e);cpu.a-p&128?cpu.setNegativeFlag():cpu.resetNegativeFlag(),cpu.a>=p?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=5},DCP_IY:function(){var e=memory.readWord(memory.readByte(cpu.pc+1))+cpu.y,p=memory.readByte(e);p=p-1&255,memory.writeByte(e,p),cpu.a-p&128?cpu.setNegativeFlag():cpu.resetNegativeFlag(),cpu.a>=p?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=8},CMP_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255,p=memory.readByte(e);cpu.a-p&128?cpu.setNegativeFlag():cpu.resetNegativeFlag(),cpu.a>=p?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=4},DEC_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255,p=memory.readByte(e);p=p-1&255,memory.writeByte(e,p),p>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=6},DCP_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255,p=memory.readByte(e);p=p-1&255,memory.writeByte(e,p),cpu.a-p&128?cpu.setNegativeFlag():cpu.resetNegativeFlag(),cpu.a>=p?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=6},CLD:function(){cpu.resetDecimalFlag(),cpu.pc+=1,cpu.clk=2},CMP_ABY:function(){var e=memory.readWord(cpu.pc+1)+cpu.y,p=memory.readByte(e);cpu.a-p&128?cpu.setNegativeFlag():cpu.resetNegativeFlag(),cpu.a>=p?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},DCP_ABY:function(){var e=memory.readWord(cpu.pc+1)+cpu.y,p=memory.readByte(e);p=p-1&255,memory.writeByte(e,p),cpu.a-p&128?cpu.setNegativeFlag():cpu.resetNegativeFlag(),cpu.a>=p?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=7},CMP_ABX:function(){var e=memory.readWord(cpu.pc+1)+cpu.x,p=memory.readByte(e);cpu.a-p&128?cpu.setNegativeFlag():cpu.resetNegativeFlag(),cpu.a>=p?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},DEC_ABX:function(){var e=memory.readWord(cpu.pc+1)+cpu.x,p=memory.readByte(e);p=p-1&255,memory.writeByte(e,p),p>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=7},DCP_ABX:function(){var e=memory.readWord(cpu.pc+1)+cpu.x,p=memory.readByte(e);p=p-1&255,memory.writeByte(e,p),cpu.a-p&128?cpu.setNegativeFlag():cpu.resetNegativeFlag(),cpu.a>=p?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.a===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=7},CPX_IMM:function(){var e=memory.readByte(cpu.pc+1);cpu.x-e&128?cpu.setNegativeFlag():cpu.resetNegativeFlag(),cpu.x>=e?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.x===e?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=2},SBC_IX:function(){var e=memory.readWord(memory.readByte(cpu.pc+1)+cpu.x&255),p=1+(255&~memory.readByte(e)),c=cpu.carryFlag()?0:1,a=cpu.a+p-c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p-1&255^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=6},ISC_IX:function(){var e=memory.readWord(memory.readByte(cpu.pc+1)+cpu.x&255);p=(p=memory.readByte(e))+1&255,memory.writeByte(e,p);var p=1+(255&~p),c=cpu.carryFlag()?0:1,a=cpu.a+p-c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p-1&255^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=8},CPX_ZP:function(){var e=memory.readByte(cpu.pc+1),p=memory.readByte(e);cpu.x-p&128?cpu.setNegativeFlag():cpu.resetNegativeFlag(),cpu.x>=p?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.x===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=3},SBC_ZP:function(){var e=memory.readByte(cpu.pc+1),p=1+(255&~memory.readByte(e)),c=cpu.carryFlag()?0:1,a=cpu.a+p-c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p-1&255^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=3},INC_ZP:function(){var e=memory.readByte(cpu.pc+1),p=memory.readByte(e);p=p+1&255,memory.writeByte(e,p),p>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=5},ISC_ZP:function(){var e=memory.readByte(cpu.pc+1);p=(p=memory.readByte(e))+1&255,memory.writeByte(e,p);var p=1+(255&~p),c=cpu.carryFlag()?0:1,a=cpu.a+p-c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p-1&255^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=5},INX:function(){cpu.x=cpu.x+1&255,cpu.x>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.x?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=1,cpu.clk=2},SBC_IMM:function(){var e=1+(255&~memory.readByte(cpu.pc+1)),p=cpu.carryFlag()?0:1,c=cpu.a+e-p;256&c?(c&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^c)&(e-1&255^c)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=c,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=2},CPX_AB:function(){var e=memory.readWord(cpu.pc+1),p=memory.readByte(e);cpu.x-p&128?cpu.setNegativeFlag():cpu.resetNegativeFlag(),cpu.x>=p?cpu.setCarryFlag():cpu.resetCarryFlag(),cpu.x===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},SBC_AB:function(){var e=memory.readWord(cpu.pc+1),p=1+(255&~memory.readByte(e)),c=cpu.carryFlag()?0:1,a=cpu.a+p-c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p-1&255^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},INC_AB:function(){var e=memory.readWord(cpu.pc+1),p=memory.readByte(e);p=p+1&255,memory.writeByte(e,p),p>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=6},ISC_AB:function(){var e=memory.readWord(cpu.pc+1);p=(p=memory.readByte(e))+1&255,memory.writeByte(e,p);var p=1+(255&~p),c=cpu.carryFlag()?0:1,a=cpu.a+p-c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p-1&255^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=6},BEQ:function(){cpu.clk=2,cpu.zeroFlag()&&(cpu.pc+=cpu.signDecode(memory.readByte(cpu.pc+1)),cpu.clk+=1),cpu.pc+=2},SBC_IY:function(){var e=memory.readWord(memory.readByte(cpu.pc+1))+cpu.y,p=1+(255&~memory.readByte(e)),c=cpu.carryFlag()?0:1,a=cpu.a+p-c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p-1&255^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=5},ISC_IY:function(){var e=memory.readWord(memory.readByte(cpu.pc+1))+cpu.y;p=(p=memory.readByte(e))+1&255,memory.writeByte(e,p);var p=1+(255&~p),c=cpu.carryFlag()?0:1,a=cpu.a+p-c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p-1&255^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=8},SBC_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255,p=1+(255&~memory.readByte(e)),c=cpu.carryFlag()?0:1,a=cpu.a+p-c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p-1&255^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=4},INC_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255,p=memory.readByte(e);p=p+1&255,memory.writeByte(e,p),p>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=6},ISC_ZPX:function(){var e=memory.readByte(cpu.pc+1)+cpu.x&255;p=(p=memory.readByte(e))+1&255,memory.writeByte(e,p);var p=1+(255&~p),c=cpu.carryFlag()?0:1,a=cpu.a+p-c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p-1&255^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=2,cpu.clk=6},SED:function(){cpu.setDecimalFlag(),cpu.pc+=1,cpu.clk=2},SBC_ABY:function(){var e=memory.readWord(cpu.pc+1)+cpu.y,p=1+(255&~memory.readByte(e)),c=cpu.carryFlag()?0:1,a=cpu.a+p-c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p-1&255^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},ISC_ABY:function(){var e=memory.readWord(cpu.pc+1)+cpu.y;p=(p=memory.readByte(e))+1&255,memory.writeByte(e,p);var p=1+(255&~p),c=cpu.carryFlag()?0:1,a=cpu.a+p-c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p-1&255^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=7},SBC_ABX:function(){var e=memory.readWord(cpu.pc+1)+cpu.x,p=1+(255&~memory.readByte(e)),c=cpu.carryFlag()?0:1,a=cpu.a+p-c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p-1&255^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=4},INC_ABX:function(){var e=memory.readWord(cpu.pc+1)+cpu.x,p=memory.readByte(e);p=p+1&255,memory.writeByte(e,p),p>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===p?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=7},ISC_ABX:function(){var e=memory.readWord(cpu.pc+1)+cpu.x;p=(p=memory.readByte(e))+1&255,memory.writeByte(e,p);var p=1+(255&~p),c=cpu.carryFlag()?0:1,a=cpu.a+p-c;256&a?(a&=255,cpu.setCarryFlag()):cpu.resetCarryFlag(),(cpu.a^a)&(p-1&255^a)&128?cpu.setOverflowFlag():cpu.resetOverflowFlag(),cpu.a=a,cpu.a>127?cpu.setNegativeFlag():cpu.resetNegativeFlag(),0===cpu.a?cpu.setZeroFlag():cpu.resetZeroFlag(),cpu.pc+=3,cpu.clk=7},setCarryFlag:function(){cpu.sr|=1},resetCarryFlag:function(){cpu.sr&=254},carryFlag:function(){return!!(1&cpu.sr)},setZeroFlag:function(){cpu.sr|=2},resetZeroFlag:function(){cpu.sr&=253},zeroFlag:function(){return!!(2&cpu.sr)},setInterruptFlag:function(){cpu.sr|=4},resetInterruptFlag:function(){cpu.sr&=251},interruptFlag:function(){return!!(4&cpu.sr)},setDecimalFlag:function(){cpu.sr|=8},resetDecimalFlag:function(){cpu.sr&=247},decimalFlag:function(){return!!(8&cpu.sr)},setBreakFlag:function(){cpu.sr|=16},resetBreakFlag:function(){cpu.sr&=239},breakFlag:function(){return!!(16&cpu.sr)},setA1Flag:function(){cpu.sr|=32},resetA1Flag:function(){cpu.sr&=223},a1Flag:function(){return!!(32&cpu.sr)},setOverflowFlag:function(){cpu.sr|=64},resetOverflowFlag:function(){cpu.sr&=191},overflowFlag:function(){return!!(64&cpu.sr)},setNegativeFlag:function(){cpu.sr|=128},resetNegativeFlag:function(){cpu.sr&=127},negativeFlag:function(){return!!(128&cpu.sr)},ex:function(e){cpu.pcPrev=cpu.pc,instructionMap[e](),cpu.cycle+=cpu.clk;for(var p=0;p<3*cpu.clk;p++)ppu.step(),memory.mapper.interrupts&&memory.mapper.step(),ppu.spriteEval();input.step(),ppu.vblDelay&&(ppu.vblDelay=0,ppu.nmiEnable=1),ppu.queuedIntCycles&&ppu.runIntCycles()},reset:function(){cpu.a=0,cpu.y=0,cpu.x=0,cpu.sp=253,cpu.pc=memory.readWord(memory.resetVector)},runInstruction:function(){cpu.showFunc(),cpu.ex(memory.readByte(cpu.pc)),cpu.showState(),ppu.showState()},showFunc:function(){console.log("executing: MEMORY[",cpu.toHex4(cpu.pc),"], ",instructionMap[memory.readByte(cpu.pc)].name,", hex ",memory.readByte(cpu.pc).toString(16))},showState:function(){console.log("current state: "),console.log("A: ",cpu.toHex2(cpu.a)),console.log("X: ",cpu.toHex2(cpu.x)),console.log("Y: ",cpu.toHex2(cpu.y)),console.log("SR: ",cpu.toHex2(cpu.sr)),console.log("SP: ",cpu.toHex4(cpu.sp)),console.log("PC: ",cpu.toHex4(cpu.pc)),console.log("PCPREV: ",cpu.toHex4(cpu.pcPrev))},unimplemented:function(){console.log("unimplemented instruction",cpu.toHex2(memory.readByte(cpu.pc)),"at",cpu.toHex4(cpu.pc))},getAddr:function(e,p){var c=e;return c<<=8,c|=p},signDecode:function(e){return 128&e&&(e=255&~e,e=-++e),e},toHex2:function(e){for(var p=e.toString(16);p.length<2;)p="0"+p;return p},toHex4:function(e){for(var p=e.toString(16);p.length<4;)p="0"+p;return p},wRamInit:function(){wRAM=new Array(2048);for(var e=0;e<wRAM.length;e++)wRAM[e]=0}},wRAM=[],instructionMap=[cpu.BRK,cpu.ORA_IX,cpu.HLT,cpu.SLO_IX,cpu.DOP,cpu.ORA_ZP,cpu.ASL_ZP,cpu.SLO_ZP,cpu.PHP,cpu.ORA_IMM,cpu.ASL_A,cpu.ANC_IMM,cpu.TOP,cpu.ORA_AB,cpu.ASL_AB,cpu.SLO_AB,cpu.BPL,cpu.ORA_IY,cpu.HLT,cpu.SLO_IY,cpu.DOP,cpu.ORA_ZPX,cpu.ASL_ZPX,cpu.SLO_ZPX,cpu.CLC,cpu.ORA_ABY,cpu.NOP,cpu.SLO_ABY,cpu.TOP,cpu.ORA_ABX,cpu.ASL_ABX,cpu.SLO_ABX,cpu.JSR,cpu.AND_IX,cpu.HLT,cpu.RLA_IX,cpu.BIT_ZP,cpu.AND_ZP,cpu.ROL_ZP,cpu.RLA_ZP,cpu.PLP,cpu.AND_IMM,cpu.ROL_A,cpu.ANC_IMM,cpu.BIT_AB,cpu.AND_AB,cpu.ROL_AB,cpu.RLA_AB,cpu.BMI,cpu.AND_IY,cpu.HLT,cpu.RLA_IY,cpu.DOP,cpu.AND_ZPX,cpu.ROL_ZPX,cpu.RLA_ZPX,cpu.SEC,cpu.AND_ABY,cpu.NOP,cpu.RLA_ABY,cpu.TOP,cpu.AND_ABX,cpu.ROL_ABX,cpu.RLA_ABX,cpu.RTI,cpu.EOR_IX,cpu.HLT,cpu.SRE_IX,cpu.DOP,cpu.EOR_ZP,cpu.LSR_ZP,cpu.SRE_ZP,cpu.PHA,cpu.EOR_IMM,cpu.LSR_A,cpu.ALR_IMM,cpu.JMP_A,cpu.EOR_AB,cpu.LSR_AB,cpu.SRE_AB,cpu.BVC,cpu.EOR_IY,cpu.HLT,cpu.SRE_IY,cpu.DOP,cpu.EOR_ZPX,cpu.LSR_ZPX,cpu.SRE_ZPX,cpu.CLI,cpu.EOR_ABY,cpu.NOP,cpu.SRE_ABY,cpu.TOP,cpu.EOR_ABX,cpu.LSR_ABX,cpu.SRE_ABX,cpu.RTS,cpu.ADC_IX,cpu.HLT,cpu.RRA_IX,cpu.DOP,cpu.ADC_ZP,cpu.ROR_ZP,cpu.RRA_ZP,cpu.PLA,cpu.ADC_IMM,cpu.ROR_A,cpu.ARR_IMM,cpu.JMP_I,cpu.ADC_AB,cpu.ROR_AB,cpu.RRA_AB,cpu.BVS,cpu.ADC_IY,cpu.HLT,cpu.RRA_IY,cpu.DOP,cpu.ADC_ZPX,cpu.ROR_ZPX,cpu.RRA_ZPX,cpu.SEI,cpu.ADC_ABY,cpu.NOP,cpu.RRA_ABY,cpu.TOP,cpu.ADC_ABX,cpu.ROR_ABX,cpu.RRA_ABX,cpu.DOP,cpu.STA_IX,cpu.DOP,cpu.SAX_IX,cpu.STY_ZP,cpu.STA_ZP,cpu.STX_ZP,cpu.SAX_ZP,cpu.DEY,cpu.DOP,cpu.TXA,cpu.XAA_IMM,cpu.STY_AB,cpu.STA_AB,cpu.STX_AB,cpu.SAX_AB,cpu.BCC,cpu.STA_IY,cpu.HLT,cpu.AHX_IY,cpu.STY_ZPX,cpu.STA_ZPX,cpu.STX_ZPY,cpu.SAX_ZPY,cpu.TYA,cpu.STA_ABY,cpu.TXS,cpu.TAS_ABY,cpu.SHY_ABX,cpu.STA_ABX,cpu.SHX_ABY,cpu.AHX_ABY,cpu.LDY_IMM,cpu.LDA_IX,cpu.LDX_IMM,cpu.LAX_IX,cpu.LDY_ZP,cpu.LDA_ZP,cpu.LDX_ZP,cpu.LAX_ZP,cpu.TAY,cpu.LDA_IMM,cpu.TAX,cpu.LAX_IMM,cpu.LDY_AB,cpu.LDA_AB,cpu.LDX_AB,cpu.LAX_AB,cpu.BCS,cpu.LDA_IY,cpu.HLT,cpu.LAX_IY,cpu.LDY_ZPX,cpu.LDA_ZPX,cpu.LDX_ZPY,cpu.LAX_ZPY,cpu.CLV,cpu.LDA_ABY,cpu.TSX,cpu.ILL,cpu.LDY_ABX,cpu.LDA_ABX,cpu.LDX_ABY,cpu.LAX_ABY,cpu.CPY_IMM,cpu.CMP_IX,cpu.DOP,cpu.DCP_IX,cpu.CPY_ZP,cpu.CMP_ZP,cpu.DEC_ZP,cpu.DCP_ZP,cpu.INY,cpu.CMP_IMM,cpu.DEX,cpu.AXS_IMM,cpu.CPY_AB,cpu.CMP_AB,cpu.DEC_AB,cpu.DCP_AB,cpu.BNE,cpu.CMP_IY,cpu.HLT,cpu.DCP_IY,cpu.DOP,cpu.CMP_ZPX,cpu.DEC_ZPX,cpu.DCP_ZPX,cpu.CLD,cpu.CMP_ABY,cpu.NOP,cpu.DCP_ABY,cpu.TOP,cpu.CMP_ABX,cpu.DEC_ABX,cpu.DCP_ABX,cpu.CPX_IMM,cpu.SBC_IX,cpu.DOP,cpu.ISC_IX,cpu.CPX_ZP,cpu.SBC_ZP,cpu.INC_ZP,cpu.ISC_ZP,cpu.INX,cpu.SBC_IMM,cpu.NOP,cpu.SBC_IMM,cpu.CPX_AB,cpu.SBC_AB,cpu.INC_AB,cpu.ISC_AB,cpu.BEQ,cpu.SBC_IY,cpu.HLT,cpu.ISC_IY,cpu.DOP,cpu.SBC_ZPX,cpu.INC_ZPX,cpu.ISC_ZPX,cpu.SED,cpu.SBC_ABY,cpu.NOP,cpu.ISC_ABY,cpu.TOP,cpu.SBC_ABX,cpu.INC_ABX,cpu.ISC_ABX],memory={mapper:0,irqVector:65534,nmiVector:65530,resetVector:65532,readByte:function(e){switch(61440&e){case 0:case 4096:return wRAM[e%2048];case 8192:case 12288:return 8212===e?ppu.oamDMA:ppu.readByte(e);case 16384:return e<16416?apu.readByte(e):memory.mapper.readByte(e);case 20480:case 24576:case 28672:case 32768:case 36864:case 40960:case 45056:case 49152:case 53248:case 57344:case 61440:return memory.mapper.readByte(e)}},readWord:function(e){if(255===e)p=memory.readByte(e-255);else var p=memory.readByte(e+1);return p<<=8,p|=memory.readByte(e)},writeByte:function(e,p){switch(61440&e){case 0:case 4096:wRAM[e%2048]=p;break;case 8192:case 12288:ppu.writeByte(e,p);break;case 16384:e<16416?16404===e?ppu.oamDMA(p):apu.writeByte(e,p):memory.mapper.writeByte(e,p);break;case 20480:case 24576:case 28672:case 32768:case 36864:case 40960:case 45056:case 49152:case 53248:case 57344:case 61440:memory.mapper.writeByte(e,p)}},writeWord:function(e,p){var c=255&p;p>>=8,memory.writeByte(e+1,p),memory.writeByte(e,c)},printChecksums:function(){console.log(memory.readByte(18).toString(16),memory.readByte(19).toString(16),memory.readByte(20).toString(16),memory.readByte(21).toString(16))},printStack:function(){for(var e=256|cpu.sp;e<512;)console.log(cpu.toHex2(memory.readByte(e))),e++}},prgRom=[],ppu={registers:[0,0,0],nmiEnable:0,m_s:0,spriteSize:0,patternTableOffset:0,spriteTableOffset:4096,incrementMode:1,nametableOffset:8192,bgr:0,spriteEnable:0,bgEnable:1,spriteLeftColumnEnable:0,bgLeftColumnEnable:0,greyScale:0,sprite0Hit:0,spriteOverflow:0,oamAddr:0,v:0,t:0,fineX:0,writeToggle:0,oamDMA:0,currentTile:[0,0,0,0],ntByteBuffer:[0,0,0,0,0,0],ntByteBufHelper:[0,0,0,0,0,0,0],bgTileBuffer:[0,0,0,0,0,0],bgAttributeBuffer:[0,0,0],tileBufferOffset:0,palletteBuffer:[0,0],spriteShiftReg:[[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0],[0,0]],attributeLatch:[0,0,0,0,0,0,0,0],spriteX:[0,0,0,0,0,0,0,0],canvasOffset:0,tileX:0,tileY:0,nametableByte:0,spriteTileOffset:0,nametableMirroring:0,graphicsDebug:0,spriteNumBuf:[0,0,0,0,0,0,0,0],evenOddToggle:0,nmiSuppress:0,vblTaken:0,queuedIntCycles:0,readBuffer:0,scanline:261,cycle:0,cycleMode:0,scanlineMode:3,a12:0,step:function(){switch(ppu.scanlineMode){case 0:switch(ppu.cycleMode){case 0:ppu.cycleMode=1,ppu.updateCurrentTile();break;case 1:switch(0===ppu.fineX&&ppu.updateCurrentTile(),7&ppu.cycle){case 0:ppu.bgEnable&&(31==(31&ppu.v)?(ppu.v&=65504,3===ppu.nametableMirroring&&(ppu.v^=1024)):ppu.v++);break;case 1:ppu.shiftRegisters(),ppu.fetchNTByte();break;case 3:ppu.fetchATByte();break;case 5:ppu.fetchTBLow();break;case 7:ppu.fetchTBHigh()}if(ppu.renderPixel(),256===ppu.cycle&&(ppu.cycleMode=2,ppu.bgEnable))if(28672!=(28672&ppu.v))ppu.v+=4096;else{ppu.v&=4095;var e=(992&ppu.v)>>5;29===e?(e=0,2===ppu.nametableMirroring&&(ppu.v^=2048)):e+=1,ppu.v&=64543,ppu.v|=e<<5}break;case 2:switch(257===ppu.cycle&&(ppu.bgEnable&&(ppu.v&=64480,ppu.v|=1055&ppu.t),ppu.a12=1),7&ppu.cycle){case 5:ppu.spritesFound<8&&ppu.fetchSpriteLow();break;case 7:ppu.spritesFound<8&&ppu.fetchSpriteHigh()}320===ppu.cycle&&(ppu.cycleMode=3);break;case 3:switch(ppu.fineX=(ppu.fineX+1)%8,7&ppu.cycle){case 0:ppu.bgEnable&&(31==(31&ppu.v)?(ppu.v&=65504,3===ppu.nametableMirroring&&(ppu.v^=1024)):ppu.v++);break;case 1:ppu.shiftRegisters(),ppu.fetchNTByte();break;case 3:ppu.fetchATByte();break;case 5:ppu.fetchTBLow();break;case 7:ppu.fetchTBHigh()}336===ppu.cycle&&(ppu.cycleMode=4);break;case 4:340===ppu.cycle&&(239===ppu.scanline&&(ppu.scanlineMode=1),ppu.cycleMode=0,ppu.cycle=-1,ppu.scanline++)}break;case 1:128&ppu.registers[2]&&ppu.nmiEnable&&!ppu.vblTaken&&(memory.writeWord((256|cpu.sp)-1,cpu.pc),cpu.sp-=2,memory.writeByte(256|cpu.sp,32|cpu.sr),cpu.sp-=1,cpu.pc=memory.readWord(memory.nmiVector),cpu.setInterruptFlag(),ppu.vblTaken=1,ppu.queuedIntCycles=21),340===ppu.cycle&&(240===ppu.scanline?ppu.scanlineMode=2:260===ppu.scanline&&(ppu.scanlineMode=3),ppu.cycleMode=0,ppu.cycle=-1,ppu.scanline=(ppu.scanline+1)%262);break;case 2:1===ppu.cycle&&(ppu.nmiSuppress||ppu.setVBlankFlag(),screen.putImageData(pixData,0,0)),128&ppu.registers[2]&&ppu.nmiEnable&&!ppu.vblTaken&&(memory.writeWord((256|cpu.sp)-1,cpu.pc),cpu.sp-=2,memory.writeByte(256|cpu.sp,32|cpu.sr),cpu.sp-=1,cpu.pc=memory.readWord(memory.nmiVector),cpu.setInterruptFlag(),ppu.vblTaken=1,ppu.queuedIntCycles=21),340===ppu.cycle&&(ppu.scanlineMode=1,ppu.cycleMode=1,ppu.cycle=-1,ppu.scanline=(ppu.scanline+1)%262);break;case 3:if(0===ppu.cycle&&128&ppu.registers[2]&&ppu.nmiEnable&&!ppu.vblTaken&&(memory.writeWord((256|cpu.sp)-1,cpu.pc),cpu.sp-=2,memory.writeByte(256|cpu.sp,32|cpu.sr),cpu.sp-=1,cpu.pc=memory.readWord(memory.nmiVector),cpu.setInterruptFlag(),ppu.vblTaken=1,ppu.queuedIntCycles=21),1===ppu.cycle&&(ppu.registers[2]&=31,ppu.canvasOffset=0,ppu.vblTaken=0,ppu.nmiSuppress=0),ppu.cycle>=280&&ppu.cycle<=304&&ppu.bgEnable&&(ppu.v&=1055,ppu.v|=64480&ppu.t),ppu.cycle>320&&ppu.cycle<=336)switch(7&ppu.cycle){case 0:ppu.bgEnable&&(31==(31&ppu.v)?(ppu.v&=65504,3===ppu.nametableMirroring&&(ppu.v^=1024)):ppu.v++);break;case 1:ppu.shiftRegisters(),ppu.fetchNTByte();break;case 3:ppu.fetchATByte();break;case 5:ppu.fetchTBLow();break;case 7:ppu.fetchTBHigh()}ppu.bgEnable?ppu.cycle+ppu.evenOddToggle===340&&(ppu.scanlineMode=0,ppu.cycleMode=0,ppu.cycle=-1,ppu.scanline=(ppu.scanline+1)%262,ppu.evenOddToggle=ppu.evenOddToggle+1&1):340===ppu.cycle&&(ppu.scanlineMode=0,ppu.cycleMode=0,ppu.cycle=-1,ppu.scanline=(ppu.scanline+1)%262,ppu.evenOddToggle=ppu.evenOddToggle+1&1)}ppu.cycle++},fetchNTByte:function(){ppu.v,ppu.v,ppu.v;var e=8192+(4095&ppu.v);ppu.nametableByte=ppu.readVRam(e),ppu.ntByteBuffer[0]=ppu.nametableByte,ppu.ntByteBufHelper[0]=ppu.cycle,ppu.nametableByte=(ppu.nametableByte<<4)+ppu.patternTableOffset+(ppu.v>>12)},fetchATByte:function(){var e=9152|3072&ppu.v|ppu.v>>4&56|ppu.v>>2&7,p=ppu.readVRam(e);p>>=64&ppu.v?4:0,p>>=2&ppu.v?2:0,p&=3,ppu.bgAttributeBuffer[0]=p},fetchTBLow:function(){ppu.bgTileBuffer[0]=ppu.readVRam(ppu.nametableByte),ppu.nametableByte+=8},fetchTBHigh:function(){ppu.bgTileBuffer[1]=ppu.readVRam(ppu.nametableByte)},shiftRegisters:function(){ppu.bgTileBuffer[2]=ppu.bgTileBuffer[0],ppu.bgTileBuffer[3]=ppu.bgTileBuffer[1],ppu.bgAttributeBuffer[1]=ppu.bgAttributeBuffer[0],ppu.ntByteBuffer[1]=ppu.ntByteBuffer[0],ppu.ntByteBufHelper[1]=ppu.ntByteBufHelper[0]},updateCurrentTile:function(){ppu.currentTile[2]=ppu.bgTileBuffer[2],ppu.currentTile[3]=ppu.bgTileBuffer[3],ppu.currentTile[1]=ppu.bgAttributeBuffer[1],ppu.currentTile[0]=ppu.ntByteBuffer[1],ppu.currentTile[4]=ppu.ntByteBufHelper[1]},fetchSpriteLow:function(){ppu.spriteTileOffset=oamBuf[ppu.spritesFound][1],2===ppu.spriteSize&&(ppu.spriteTileOffset&=254),ppu.spriteTileOffset*=16;var e=ppu.scanline+1-oamBuf[ppu.spritesFound][0];128&oamBuf[ppu.spritesFound][2]&&(e=8*ppu.spriteSize-e-1),e>7&&(e+=8),ppu.spriteTileOffset+=e,2===ppu.spriteSize?ppu.spriteTileOffset+=1&oamBuf[ppu.spritesFound][1]?4096:0:ppu.spriteTileOffset+=ppu.spriteTableOffset;var p=ppu.readVRam(ppu.spriteTileOffset);64&oamBuf[ppu.spritesFound][2]&&(p=ppu.xFlip(p)),ppu.spriteShiftReg[ppu.spritesFound][0]=p,ppu.spriteTileOffset+=8},fetchSpriteHigh:function(){var e=ppu.readVRam(ppu.spriteTileOffset);64&oamBuf[ppu.spritesFound][2]&&(e=ppu.xFlip(e)),ppu.spriteShiftReg[ppu.spritesFound][1]=e,ppu.spritesFound++,ppu.spritesFound%=8},renderPixel:function(){if(ppu.bgEnable)if(!ppu.bgLeftColumnEnable&&ppu.cycle<9){u=bgPal[0][0];pixData.data[ppu.canvasOffset]=palette[u][0],pixData.data[ppu.canvasOffset+1]=palette[u][1],pixData.data[ppu.canvasOffset+2]=palette[u][2],ppu.canvasOffset+=4,ppu.fineX=(ppu.fineX+1)%8}else{var e=ppu.currentTile[2]>>7-ppu.fineX&1?1:0;e+=ppu.currentTile[3]>>7-ppu.fineX&1?2:0;var p=ppu.currentTile[1];if(0===e&&(p=0),(u=bgPal[p][e])>63&&console.log("ppu.renderpixel: color out of range, check bgPal",u),pixData.data[ppu.canvasOffset]=palette[u][0],pixData.data[ppu.canvasOffset+1]=palette[u][1],pixData.data[ppu.canvasOffset+2]=palette[u][2],ppu.canvasOffset+=4,ppu.fineX=(ppu.fineX+1)%8,ppu.spriteEnable&&!(6&!ppu.registers[1]&&ppu.cycle<9))for(var c=7;c>=0;c--)if(ppu.cycle-1>=ppu.spriteX[c]&&ppu.cycle-1<ppu.spriteX[c]+8&&ppu.spriteX[c]<255){var a=ppu.cycle-1-ppu.spriteX[c],r=ppu.spriteShiftReg[c][0]>>7-a&1?1:0;if(0!==(r+=ppu.spriteShiftReg[c][1]>>7-a&1?2:0)&&(0!==ppu.spriteNumBuf[c]||0===e||256===ppu.cycle||64&ppu.registers[2]||!ppu.spriteLeftColumnEnable&&ppu.cycle<9||(ppu.registers[2]|=64),!(32&ppu.attributeLatch[c])||0===e)){var u=spritePal[3&ppu.attributeLatch[c]][r];pixData.data[ppu.canvasOffset-4]=palette[u][0],pixData.data[ppu.canvasOffset-3]=palette[u][1],pixData.data[ppu.canvasOffset-2]=palette[u][2]}}}else pixData.data[ppu.canvasOffset]=palette[15][0],pixData.data[ppu.canvasOffset+1]=palette[15][1],pixData.data[ppu.canvasOffset+2]=palette[15][2],ppu.canvasOffset+=4},setVBlankFlag:function(){ppu.registers[2]|=128},runIntCycles:function(){for(ppu.queuedIntCycles;ppu.queuedIntCycles>0;ppu.queuedIntCycles--)ppu.step()},xFlip:function(e){var p=0;return p|=128&e?1:0,p|=64&e?2:0,p|=32&e?4:0,p|=16&e?8:0,p|=8&e?16:0,p|=4&e?32:0,p|=2&e?64:0,p|=1&e?128:0},srMode:0,srCase2Mode:1,spritesFound:0,oamPtr:0,spriteTransfer:0,spriteEval:function(){if(ppu.scanline<240)switch(ppu.srMode){case 0:ppu.srMode=1;break;case 1:if(!(ppu.cycle%2))if(ppu.cycle<64){var e=ppu.cycle/2-1;oamBuf[Math.floor(e/4)][e%4]=255}else oamBuf[7][3]=255,ppu.srMode=2;break;case 2:switch(ppu.srCase2Mode){case 1:ppu.cycle%2||(oamBuf[ppu.spritesFound][0]=oam[ppu.oamPtr][0],oamBuf[ppu.spritesFound][4]=ppu.oamPtr,ppu.scanline>=oamBuf[ppu.spritesFound][0]&&ppu.scanline<oamBuf[ppu.spritesFound][0]+8*ppu.spriteSize&&ppu.scanline<239?(oamBuf[ppu.spritesFound][0]++,ppu.srCase2Mode=2,ppu.spriteTransfer=1):64===++ppu.oamPtr&&(ppu.srCase2Mode=3,ppu.oamPtr=0,ppu.spritesFound=0));break;case 2:ppu.cycle%2||(ppu.spriteTransfer<3?(oamBuf[ppu.spritesFound][ppu.spriteTransfer]=oam[ppu.oamPtr][ppu.spriteTransfer],ppu.spriteTransfer++):(oamBuf[ppu.spritesFound][3]=oam[ppu.oamPtr][3],ppu.spriteTransfer=0,ppu.oamPtr++,ppu.spritesFound++,ppu.srCase2Mode=1,64!==ppu.oamPtr&&8!==ppu.spritesFound||(ppu.srCase2Mode=3,ppu.oamPtr=0,ppu.spritesFound=0)));break;case 3:oamBufPrev=oamBuf,256===ppu.cycle&&(ppu.srCase2Mode=1,ppu.srMode=3,ppu.oamPtr=0,ppu.spritesFound=0,ppu.spriteTransfer=0)}break;case 3:switch(7&ppu.cycle){case 1:ppu.attributeLatch[ppu.spritesFound]=oamBuf[ppu.spritesFound][2],ppu.spriteNumBuf[ppu.spritesFound]=oamBuf[ppu.spritesFound][4];break;case 3:ppu.spriteX[ppu.spritesFound]=oamBuf[ppu.spritesFound][3]}320===ppu.cycle&&(ppu.spritesFound=0,ppu.srMode=4);break;case 4:340===ppu.cycle&&(ppu.srMode=0)}},readByte:function(e){switch(e%8){case 0:return ppu.registers[0];case 1:return ppu.registers[1];case 2:p=ppu.registers[2];return ppu.registers[2]&=127,ppu.writeToggle=0,241===ppu.scanline&&1===ppu.cycle&&(ppu.nmiSuppress=1,console.log("nmi-supress")),p;case 3:return ppu.oamAddr;case 4:return oam[Math.floor(ppu.oamAddr/4)][ppu.oamAddr];case 5:case 6:return 255&ppu.v;case 7:var p=ppu.readBuffer;return ppu.readBuffer=ppu.readVRam(ppu.v),ppu.v+=ppu.incrementMode,p}},writeByte:function(e,p){switch(e%8){case 0:ppu.registers[0]=p,128&p?ppu.vblDelay=1:(ppu.nmiEnable=0,ppu.vblDelay=0),128&p||!ppu.vblTaken||(ppu.vblTaken=0),ppu.m_s=64&p?1:0,ppu.spriteSize=32&p?2:1,ppu.patternTableOffset=(16&p)<<8,ppu.spriteTableOffset=(8&p)<<9,ppu.incrementMode=4&p?32:1,ppu.t&=62463;var c=(3&p)<<10;ppu.t|=c;break;case 1:ppu.registers[1]=p,ppu.bgr=p>>5,ppu.spriteEnable=16&p?1:0,ppu.bgEnable=8&p?1:0,ppu.spriteLeftColumnEnable=4&p?1:0,ppu.bgLeftColumnEnable=(2&p)>>1,ppu.greyScale=1&p;break;case 2:break;case 3:return ppu.oamAddr;case 4:oam[Math.floor(ppu.oamAddr/4)][ppu.oamAddr%4]=p;break;case 5:ppu.writeToggle?(ppu.t&=3103,ppu.t|=(7&p)<<12,ppu.t|=(248&p)<<2,ppu.writeToggle=0):(ppu.fineX=7&p,ppu.t&=65504,ppu.t|=p>>3,ppu.writeToggle=1);break;case 6:ppu.writeToggle?(ppu.t&=65280,ppu.t|=p,ppu.v=ppu.t,ppu.writeToggle=0):(ppu.t&=255,ppu.t|=(63&p)<<8,ppu.writeToggle=1),ppu.a12=1;break;case 7:ppu.writeVRam(ppu.v,p),ppu.v+=ppu.incrementMode,ppu.a12=1}},readVRam:function(e){switch(61440&(e&=16383)){case 0:case 4096:return memory.mapper.readVRam(e);case 8192:var p=1023&e;return nameTable[e>>10&3][p];case 12288:switch(3840&e){case 0:case 256:case 512:case 768:return nameTable[0][e-12288];case 1024:case 1280:case 1536:case 1792:switch(ppu.nametableMirroring){case 0:return nameTable[0][e-13312];case 1:return nameTable[1][e-13312]}break;case 2048:case 2304:case 2560:case 2816:switch(ppu.nametableMirroring){case 0:return nameTable[1][e-14336];case 1:return nameTable[0][e-14336]}break;case 3072:case 3328:case 3584:return nameTable[1][e-15360];case 3840:return e=(e-16128)%32,e<15?bgPal[Math.floor(e/4)][e%4]:spritePal[Math.floor(e/4)-4][e%4]}}},writeVRam:function(e,p){switch(61440&(e&=16383)){case 0:case 4096:memory.mapper.writeVRam(e,p);break;case 8192:var c=1023&e;nameTable[e>>10&3][c]=p;break;case 12288:switch(3840&e){case 0:case 256:case 512:case 768:nameTable[0][e-12288]=p;break;case 1024:case 1280:case 1536:case 1792:switch(ppu.nametableMirroring){case 2:nameTable[0][e-13312]=p;break;case 3:nameTable[1][e-13312]=p}break;case 2048:case 2304:case 2560:case 2816:switch(ppu.nametableMirroring){case 2:nameTable[1][e-14336]=p;break;case 3:nameTable[0][e-14336]=p}break;case 3072:case 3328:case 3584:return nameTable[3][e-15360];case 3840:(e=(e-16128)%32)<=15?(e%4==0&&(spritePal[Math.floor(e/4)][0]=p),bgPal[Math.floor(e/4)][e%4]=p):(e%4==0&&(bgPal[Math.floor(e/4)-4][0]=p),spritePal[Math.floor(e/4)-4][e%4]=p)}}},oamDMA:function(e){e<<=8;for(var p=0;p<256;p++){oam[Math.floor(p/4)][p%4]=memory.readByte(e+p);for(var c=0;c<6;c++)ppu.step(),memory.mapper.step(),ppu.spriteEval()}},showState:function(){console.log("ppu state:"),console.log("mode:",ppu.cycleMode),console.log("cycle:",ppu.cycle),console.log("scanline:",ppu.scanline)},canvasInit:function(){var e=document.getElementById("screen"),p=document.getElementById("screen-container"),c=p.clientHeight,a=p.clientWidth;console.log(c,a),a>=c?e.style.height="100%":e.style.width="100%",screen=e.getContext("2d"),pixData=screen.createImageData(256,240);for(var r=0;r<pixData.data.length;r+=4)pixData.data[r]=0,pixData.data[r+1]=0,pixData.data[r+2]=0,pixData.data[r+3]=255;screen.imageSmoothingEnabled=!1,screen.putImageData(pixData,0,0)},oamInit:function(){for(e=0;e<64;e++)oam[e]=[0,0,0,0];for(var e=0;e<8;e++)oamBuf[e]=[0,0,0,0,0]},init:function(){ppu.canvasInit(),ppu.oamInit()},customPPUTest:function(){for(e=0;e<prgRom.length;e++)prgRom[e]=234;memory.writeByte(65519,232),memory.writeByte(65520,200),memory.writeByte(65521,142),memory.writeWord(65522,8197),memory.writeByte(65524,140),memory.writeWord(65525,8197),memory.writeByte(65527,76),memory.writeWord(65528,32768),memory.writeWord(65534,32768),memory.writeWord(65532,32768),memory.writeWord(65530,32768);for(e=0;e<960;e++)nameTable[0][e]=0,nameTable[1][e]=1;for(e=960;e<1024;e++)nameTable[0][e]=27,nameTable[1][e]=228;for(var e=0;e<4096;e+=32)chrRom[e]=24,chrRom[e+1]=40,chrRom[e+2]=8,chrRom[e+3]=8,chrRom[e+4]=8,chrRom[e+5]=8,chrRom[e+6]=8,chrRom[e+7]=62,chrRom[e+8]=24,chrRom[e+9]=40,chrRom[e+10]=8,chrRom[e+11]=8,chrRom[e+12]=8,chrRom[e+13]=8,chrRom[e+14]=8,chrRom[e+15]=62,chrRom[e+=16]=24,chrRom[e+1]=36,chrRom[e+2]=4,chrRom[e+3]=8,chrRom[e+4]=16,chrRom[e+5]=32,chrRom[e+6]=64,chrRom[e+7]=126,chrRom[e+8]=24,chrRom[e+9]=36,chrRom[e+10]=4,chrRom[e+11]=8,chrRom[e+12]=16,chrRom[e+13]=32,chrRom[e+14]=64,chrRom[e+15]=126}},chrRom=[],nameTable=[[],[],[],[]],bgPal=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],spritePal=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],oam=[],oamBuf=[],oamBufPrev=[],pixData=[],palette=[[124,124,124],[0,0,252],[0,0,188],[68,40,188],[148,0,132],[168,0,32],[168,16,0],[136,20,0],[80,48,0],[0,120,0],[0,104,0],[0,88,0],[0,64,88],[0,0,0],[0,0,0],[0,0,0],[188,188,188],[0,120,248],[0,88,248],[104,68,252],[216,0,204],[228,0,88],[248,56,0],[228,92,16],[172,124,0],[0,184,0],[0,168,0],[0,168,68],[0,136,136],[0,0,0],[0,0,0],[0,0,0],[248,248,248],[60,188,252],[104,136,252],[152,120,248],[248,120,248],[248,88,152],[248,120,88],[252,160,68],[248,184,0],[184,248,24],[88,216,84],[88,248,152],[0,232,216],[120,120,120],[0,0,0],[0,0,0],[252,252,252],[164,228,252],[184,184,248],[216,184,248],[248,184,248],[248,164,192],[240,208,176],[252,224,168],[248,216,120],[216,248,120],[184,248,184],[184,248,216],[0,252,252],[248,216,248],[0,0,0],[0,0,0]],input={shiftRegisters1:[0,0,0,0,0,0,0,0],strobe1:0,shiftRegisters2:[0,0,0,0,0,0,0,0],strobe2:0,keyDown:function(e){switch(e.keyCode){case 65:input.shiftRegisters1[0]=1;break;case 83:input.shiftRegisters1[1]=1;break;case 38:input.shiftRegisters1[4]=1;break;case 40:input.shiftRegisters1[5]=1;break;case 37:input.shiftRegisters1[6]=1;break;case 39:input.shiftRegisters1[7]=1;break;case 13:input.shiftRegisters1[3]=1;break;case 16:input.shiftRegisters1[2]=1}},keyUp:function(e){switch(e.keyCode){case 65:input.shiftRegisters1[0]=0;break;case 83:input.shiftRegisters1[1]=0;break;case 38:input.shiftRegisters1[4]=0;break;case 40:input.shiftRegisters1[5]=0;break;case 37:input.shiftRegisters1[6]=0;break;case 39:input.shiftRegisters1[7]=0;break;case 13:input.shiftRegisters1[3]=0;break;case 16:input.shiftRegisters1[2]=0}},step:function(){apu.joypad1&&(input.strobe1=0),apu.joypad2&&(input.strobe2=0)}},interrupt={step:function(){memory.mapper.irqStep()}},mapper0={unused:0,interrupts:0,readByte:function(e){switch(61440&e){case 0:case 4096:case 8192:case 12288:console.log("mapper0.readByte Invalid addr");break;case 16384:case 20480:(mapper0.unused=0)&&(console.log("memory.readByte(): unused space"),cpu.showFunc(),cpu.showState(),console.log(e),mapper0.unused=1);break;case 24576:case 28672:return mapper0.prgRam[e-24576];case 32768:case 36864:case 40960:case 45056:case 49152:case 53248:case 57344:case 61440:return prgRom[e-32768]}},writeByte:function(e,p){switch(61440&e){case 0:case 4096:case 8192:case 12288:console.log("mapper0.readByte Invalid addr");break;case 16384:case 20480:(mapper0.unused=0)&&(console.log("memory.readByte(): unused space"),cpu.showFunc(),cpu.showState(),console.log(e),mapper0.unused=1);break;case 24576:case 28672:mapper0.prgRam[e-24576]=p;break;case 32768:case 36864:case 40960:case 45056:case 49152:case 53248:case 57344:case 61440:prgRom[e-32768]=p}},readVRam:function(e){switch(61440&e){case 0:case 4096:return chrRom[e];case 8192:case 12288:case 16384:case 20480:case 24576:case 28672:case 32768:case 36864:case 40960:case 45056:case 49152:case 53248:case 57344:case 61440:console.log("mapper0.readVram: unused address space")}},writeVRam:function(e,p){switch(61440&e){case 0:case 4096:chrRom[e]=p;break;case 8192:case 12288:case 16384:case 20480:case 24576:case 28672:case 32768:case 36864:case 40960:case 45056:case 49152:case 53248:case 57344:case 61440:console.log("mapper0.writeVram: unused address space")}},init:function(){16384===prgRom.length||prgRom.length>32768&&console.log("Mapper0.init; ROM too big"),mapper0.prgRam=new Array(8192),ppu.patternTableOffset=0},step:function(){}},mapper1={romBankMode:0,chrBankMode:0,romBankSelect:0,chrBankSelect:[0,0],romBankOffset:[0,16384],chrBankOffset:[0,4096],shiftReg:0,shiftWrites:0,readByte:function(e){switch(61440&e){case 0:case 4096:case 8192:case 12288:console.log("mapper1.readByte Invalid addr");break;case 16384:case 20480:console.log("mapper1.readByte unused address space");break;case 24576:case 28672:return mapper1.prgRam[e-24576];case 32768:case 36864:case 40960:case 45056:return prgRom[e-32768+mapper4.romBankOffset[0]];case 49152:case 53248:case 57344:case 61440:return prgRom[e-49152+mapper4.romBankOffset[1]]}},writeByte:function(e,p){switch(61440&e){case 0:case 4096:case 8192:case 12288:console.log("mapper1.writeByte: Invalid addr");break;case 16384:case 20480:console.log("mapper1.readByte: unused address space");break;case 24576:case 28672:mapper1.prgRam[e-24576]=p;break;case 32768:case 36864:128&p?(mapper1.shiftReg=0,mapper1.shiftWrites=0):(mapper1.shiftReg>>=1,mapper1.shiftReg|=(1&p)<<4,5===++mapper1.shiftWrites&&(mapper1.shiftWrites=0,mapper1.setReg89()));break;case 40960:case 45056:128&p?(mapper1.shiftReg=0,mapper1.shiftWrites=0):(mapper1.shiftReg>>=1,mapper1.shiftReg|=(1&p)<<4,5===++mapper1.shiftWrites&&(mapper1.shiftWrites=0,mapper1.setRegAB()));break;case 49152:case 53248:128&p?(mapper1.shiftReg=0,mapper1.shiftWrites=0):(mapper1.shiftReg>>=1,mapper1.shiftReg|=(1&p)<<4,5===++mapper1.shiftWrites&&(mapper1.shiftWrites=0,mapper1.setRegCD()));break;case 57344:case 61440:128&p?(mapper1.shiftReg=0,mapper1.shiftWrites=0):(mapper1.shiftReg>>=1,mapper1.shiftReg|=(1&p)<<4,5===++mapper1.shiftWrites&&(mapper1.shiftWrites=0,mapper1.setRegEF()))}},readVRam:function(e){switch(12288&e){case 0:return chrRom[e+mapper1.chrBankOffset[0]];case 4096:return chrRom[e+mapper1.chrBankOffset[1]-4096];case 8192:case 12288:case 16384:case 20480:case 24576:case 28672:case 32768:case 36864:case 40960:case 45056:case 49152:case 53248:case 57344:case 61440:console.log("mapper1.readVRam invalid addr")}},writeVRam:function(e,p){switch(12288&e){case 0:chrRom[e+mapper1.chrBankOffset[0]]=p;break;case 4096:chrRom[e+mapper1.chrBankOffset[1]-4096]=p;break;case 8192:case 12288:case 16384:case 20480:case 24576:case 28672:case 32768:case 36864:case 40960:case 45056:case 49152:case 53248:case 57344:case 61440:console.log("mapper1.readVRam invalid addr")}},setReg89:function(){ppu.mirroring=3&mapper1.shiftReg,mapper1.shiftReg>>=2,mapper1.setRomBankMode(),mapper1.shiftReg>>=2,mapper1.setChrBankMode(),mapper1.shiftReg=0},setRegAB:function(){mapper1.setChrBank0(),mapper1.shiftReg=0},setRegCD:function(){mapper1.setChrBank1(),mapper1.shiftReg=0},setRegEF:function(){mapper1.setRomBank(),mapper1.shiftReg=0},setRomBankMode:function(){mapper1.romBankMode=3&mapper1.shiftReg,mapper1.romBankMode<=1?(mapper1.romBankOffset[0]=16384*mapper1.romBankSelect,mapper1.romBankOffset[1]=mapper1.romBankOffset[0]+16384):2===mapper1.romBankMode?(mapper1.romBankOffset[0]=32768,mapper1.romBankOffset[1]=16384*mapper1.romBankSelect):3===mapper1.romBankMode&&(mapper1.romBankOffset[0]=16384*mapper1.romBankSelect,mapper1.romBankOffset[1]=prgRom.length-16384)},setChrBankMode:function(){mapper1.chrBankMode=mapper1.shiftReg,0===mapper1.chrBankMode?(mapper1.chrBankOffset[0]=4096*mapper1.chrBankSelect[0],mapper1.chrBankOffset[1]=mapper1.chrBankOffset[0]+4096):1===mapper1.chrBankMode&&(mapper1.chrBankOffset[0]=4096*mapper1.chrBankSelect[0],mapper1.romBankOffset[1]=4096*mapper1.chrBankSelect[1])},setChrBank0:function(){0===mapper1.chrBankMode?(mapper1.chrBankSelect[0]=30&mapper1.shiftReg,mapper1.chrBankOffset[0]=4096*mapper1.chrBankSelect[0],mapper1.chrBankOffset[1]=mapper1.chrBankOffset[0]+4096):(mapper1.chrBankSelect[0]=mapper1.shiftReg,mapper1.chrBankOffset[0]=4096*mapper1.chrBankSelect[0])},setChrBank1:function(){1===mapper1.chrBankMode&&(mapper1.chrBankSelect[1]=mapper1.shiftReg,mapper1.chrBankOffset[1]=4096*mapper1.chrBankOffset[1])},setRomBank:function(){mapper1.romBankMode<=1?(mapper1.romBankSelect=30&mapper1.shiftReg,mapper1.romBankOffset[0]=16384*mapper1.romBankSelect,mapper1.romBankOffset[1]=mapper1.romBankOffset[0]+16384):2===mapper1.romBankMode?(mapper1.romBankSelect=mapper1.shiftReg,mapper1.romBankOffset[0]=32768,mapper1.romBankOffset[1]=16384*mapper1.romBankSelect):3===mapper1.romBankMode&&(mapper1.romBankSelect=mapper1.shiftReg,mapper1.romBankOffset[0]=16384*mapper1.romBankSelect,mapper1.romBankOffset[1]=prgRom.length-16384)},init:function(){mapper1.prgRam=new Array(8192)},irqStep:function(){}},mapper4={prgRam:[],prgRomBankMode:0,chrRomBankMode:0,bankSelect:0,bankRegister:[0,0,0,0,0,0,0,0],romBankOffset:[0,0,0,0],chrBankOffset:[0,0,0,0,0,0,0,0],nametableMirroring:0,writeProtect:0,ramChipEnable:0,irqLatch:0,irqReloadRequest:0,irqEnable:0,irqCounter:0,lastEdge:0,intCycles:0,interrupts:1,readByte:function(e){switch(61440&e){case 0:case 4096:case 8192:case 12288:console.log("mapper4.readByte Invalid addr");break;case 16384:case 20480:console.log("mapper4.readByte unused address space");break;case 24576:case 28672:return mapper4.prgRam[e-24576];case 32768:case 36864:return prgRom[e-32768+mapper4.romBankOffset[0]];case 40960:case 45056:return prgRom[e-40960+mapper4.romBankOffset[1]];case 49152:case 53248:return prgRom[e-49152+mapper4.romBankOffset[2]];case 57344:case 61440:return prgRom[e-57344+mapper4.romBankOffset[3]]}},writeByte:function(e,p){switch(61440&e){case 0:case 4096:case 8192:case 12288:console.log("mapper4.readByte: Invalid addr");break;case 16384:case 20480:console.log("mapper4.readByte: unused address space");break;case 24576:case 28672:mapper4.prgRam[e-24576]=p;break;case 32768:case 36864:if(e%2)switch(mapper4.bankSelect){case 0:mapper4.bankRegister[0]=p,mapper4.chrRomBankMode?(mapper4.chrBankOffset[4]=1024*(254&p),mapper4.chrBankOffset[5]=1024*(1|p)):(mapper4.chrBankOffset[0]=1024*(254&p),mapper4.chrBankOffset[1]=1024*(1|p));break;case 1:mapper4.bankRegister[1]=p,mapper4.chrRomBankMode?(mapper4.chrBankOffset[6]=1024*(254&p),mapper4.chrBankOffset[7]=1024*(1|p)):(mapper4.chrBankOffset[2]=1024*(254&p),mapper4.chrBankOffset[3]=1024*(1|p));break;case 2:mapper4.bankRegister[2]=p,mapper4.chrRomBankMode?mapper4.chrBankOffset[0]=1024*p:mapper4.chrBankOffset[4]=1024*p;break;case 3:mapper4.bankRegister[3]=p,mapper4.chrRomBankMode?mapper4.chrBankOffset[1]=1024*p:mapper4.chrBankOffset[5]=1024*p;break;case 4:mapper4.bankRegister[4]=p,mapper4.chrRomBankMode?mapper4.chrBankOffset[2]=1024*p:mapper4.chrBankOffset[6]=1024*p;break;case 5:mapper4.bankRegister[5]=p,mapper4.chrRomBankMode?mapper4.chrBankOffset[3]=1024*p:mapper4.chrBankOffset[7]=1024*p;break;case 6:mapper4.bankRegister[6]=p,mapper4.prgRomBankMode?mapper4.romBankOffset[2]=8192*(63&p):mapper4.romBankOffset[0]=8192*(63&p);break;case 7:mapper4.bankRegister[7]=p,mapper4.romBankOffset[1]=8192*(63&p);break;default:console.log("mmc.writeByte: invalid bankSelect")}else mapper4.chrRomBankMode!==(128&p)>>7&&mapper4.setChrBankMode((128&p)>>7),mapper4.prgRomBankMode!==(64&p)>>6&&mapper4.setRomBankMode((64&p)>>6),mapper4.bankSelect=7&p;break;case 40960:case 45056:e%2?(mapper4.ramChipEnable=(7&p)>>7,mapper4.writeProtect=(6&p)>>6&1):mapper4.nametableMirroring=1&p;break;case 49152:case 53248:e%2?(mapper4.irqReloadRequest=1,mapper4.irqCounter=0):mapper4.irqLatch=p;break;case 57344:case 61440:if(e%2){mapper4.irqEnable=1;break}mapper4.irqEnable=0}},readVRam:function(e){switch(12288&e){case 0:switch(3840&e){case 0:case 256:case 512:case 768:return chrRom[e+mapper4.chrBankOffset[0]];case 1024:case 1280:case 1536:case 1792:return chrRom[e+mapper4.chrBankOffset[1]-1024];case 2048:case 2304:case 2560:case 2816:return chrRom[e+mapper4.chrBankOffset[2]-2048];case 3072:case 3328:case 3584:case 3840:return chrRom[e+mapper4.chrBankOffset[3]-3072]}break;case 4096:switch(3840&e){case 0:case 256:case 512:case 768:return chrRom[e+mapper4.chrBankOffset[4]-4096];case 1024:case 1280:case 1536:case 1792:return chrRom[e+mapper4.chrBankOffset[5]-5120];case 2048:case 2304:case 2560:case 2816:return chrRom[e+mapper4.chrBankOffset[6]-6144];case 3072:case 3328:case 3584:case 3840:return chrRom[e+mapper4.chrBankOffset[7]-7168]}break;case 8192:case 12288:case 16384:case 20480:case 24576:case 28672:case 32768:case 36864:case 40960:case 45056:case 49152:case 53248:case 57344:case 61440:console.log("mapper4.readVRam invalid addr")}},writeVRam:function(e,p){switch(12288&e){case 0:switch(3840&e){case 0:case 256:case 512:case 768:chrRom[e+mapper4.chrBankOffset[0]]=p;break;case 1024:case 1280:case 1536:case 1792:chrRom[e+mapper4.chrBankOffset[1]-1024]=p;break;case 2048:case 2304:case 2560:case 2816:chrRom[e+mapper4.chrBankOffset[2]-2048]=p;break;case 3072:case 3328:case 3584:case 3840:chrRom[e+mapper4.chrBankOffset[3]-3072]=p}break;case 4096:switch(3840&e){case 0:case 256:case 512:case 768:chrRom[e+mapper4.chrBankOffset[4]-4096]=p;break;case 1024:case 1280:case 1536:case 1792:chrRom[e+mapper4.chrBankOffset[5]-5120]=p;break;case 2048:case 2304:case 2560:case 2816:chrRom[e+mapper4.chrBankOffset[6]-6144]=p;break;case 3072:case 3328:case 3584:case 3840:chrRom[e+mapper4.chrBankOffset[7]-7168]=p}break;case 8192:case 12288:case 16384:case 20480:case 24576:case 28672:case 32768:case 36864:case 40960:case 45056:case 49152:case 53248:case 57344:case 61440:console.log("mapper4.writeVRam invalid addr")}},setRomBankMode:function(e){switch(mapper4.prgRomBankMode=e,e){case 0:mapper4.romBankOffset[2]=prgRom.length-16384,mapper4.romBankOffset[0]=8192*(63&mapper4.bankRegister[6]);break;case 1:mapper4.romBankOffset[0]=prgRom.length-16384,mapper4.romBankOffset[2]=8192*(63&mapper4.bankRegister[6]);break;default:console.log("mapper4.setRomBankMode: invalid mode")}},setChrBankMode:function(e){switch(mapper4.chrRomBankMode=e,e){case 0:mapper4.chrBankOffset[0]=1024*(254&mapper4.bankRegister[0]),mapper4.chrBankOffset[1]=1024*(1|mapper4.bankRegister[0]),mapper4.chrBankOffset[2]=1024*(254&mapper4.bankRegister[1]),mapper4.chrBankOffset[3]=1024*(1|mapper4.bankRegister[1]),mapper4.chrBankOffset[4]=1024*mapper4.bankRegister[2],mapper4.chrBankOffset[5]=1024*mapper4.bankRegister[3],mapper4.chrBankOffset[6]=1024*mapper4.bankRegister[4],mapper4.chrBankOffset[7]=1024*mapper4.bankRegister[5];break;case 1:mapper4.chrBankOffset[4]=1024*(254&mapper4.bankRegister[0]),mapper4.chrBankOffset[5]=1024*(1|mapper4.bankRegister[0]),mapper4.chrBankOffset[6]=1024*(254&mapper4.bankRegister[1]),mapper4.chrBankOffset[7]=1024*(1|mapper4.bankRegister[1]),mapper4.chrBankOffset[0]=1024*mapper4.bankRegister[2],mapper4.chrBankOffset[1]=1024*mapper4.bankRegister[3],mapper4.chrBankOffset[2]=1024*mapper4.bankRegister[4],mapper4.chrBankOffset[3]=1024*mapper4.bankRegister[5];break;default:console.log("mapper4.setChrBankMode: invalid mode")}},init:function(){mapper4.romBankOffset[3]=prgRom.length-8192,mapper4.romBankOffset[2]=prgRom.length-16384,mapper4.romBankOffset[1]=8192,mapper4.chrBankOffset[1]=1024,mapper4.chrBankOffset[2]=2048,mapper4.chrBankOffset[3]=3072,mapper4.chrBankOffset[4]=4096,mapper4.chrBankOffset[5]=5120,mapper4.chrBankOffset[6]=6144,mapper4.chrBankOffset[7]=7168,mapper4.prgRam=new Array(8192)},step:function(){ppu.a12&&(mapper4.irqCounter--,ppu.a12=0,mapper4.irqReloadRequest&&(mapper4.irqCounter=mapper4.irqLatch,mapper4.irqReloadRequest=0),-1===mapper4.irqCounter&&mapper4.irqEnable&&!cpu.interruptFlag()&&(memory.writeWord((256|cpu.sp)-1,cpu.pc),cpu.sp=cpu.sp-2&255,memory.writeByte(256|cpu.sp,32|cpu.sr),cpu.sp=cpu.sp-1&255,cpu.pc=memory.readWord(memory.irqVector),mapper4.irqCounter=mapper4.irqLatch,cpu.setInterruptFlag(),1===mapper4.intCycles&&(ppu.queuedIntCycles=21)))}},mapperInit=function(e){memory.mapper=mapperMap[e],memory.mapper.init()},mapperMap=[mapper0,mapper1,0,0,mapper4],debug={callStack:[["reset",0]]},apu={joypad1:0,joypad2:0,readByte:function(e){switch(e){case 16406:p=input.shiftRegisters1[input.strobe1];return input.strobe1=(input.strobe1+1)%8,p;case 16407:var p=input.shiftRegisters2[input.strobe2];return input.strobe2=(input.strobe2+1)%8,p}},writeByte:function(e,p){switch(e){case 16406:apu.joypad1=1&p;break;case 16407:apu.joypad2=1&p}}};